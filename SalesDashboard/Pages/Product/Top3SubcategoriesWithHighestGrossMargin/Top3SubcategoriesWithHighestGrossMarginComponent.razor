@using Microsoft.EntityFrameworkCore
@using SalesDashboard.Components.Shared.SpinnerOverlay
@using SalesDashboard.Entities

@implements IDisposable
@inject IDbContextFactory<AdventureWorksContext> DbFactory

<SpinnerOverlayComponent IsVisible="IsChartDataLoading">
    <div class="top-3-subcategories-with-highest-gross-margin">
        <MudChart ChartType="ChartType.StackedBar"
                  ChartSeries="ChartSeries"
                  ChartOptions="ChartOptions"
                  Width="100%"
                  Height="100%" />
    </div>
</SpinnerOverlayComponent>

@code {
    [CascadingParameter]
    public ProductFilterStateProviderComponent ProductFilterStateProviderComponent { get; set; } = null!;

    private IDisposable? ProductFilterChangedSubscription { get; set; }

    private bool IsChartDataLoading { get; set; } = false;

    public List<ChartSeries> ChartSeries { get; set; } = new();

    private ChartOptions ChartOptions { get; set; } = new()
    {
        YAxisTicks = 1,
        YAxisFormat = "P2"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            ProductFilterChangedSubscription = ProductFilterStateProviderComponent.ProductFilterChanged
                .Throttle(TimeSpan.FromMilliseconds(25))
                .Subscribe(async _ => await RequeryChartDataAsync());

            await RequeryChartDataAsync();
        }
    }

    private async Task RequeryChartDataAsync()
    {
        IsChartDataLoading = true;

        await InvokeAsync(StateHasChanged);

        var period = ProductFilterStateProviderComponent.Period.Value;
        var countryRegionNames = ProductFilterStateProviderComponent.CountryRegionNames.Value;
        var productCategoryNames = ProductFilterStateProviderComponent.ProductCategoryNames.Value;
        var productSubcategoryNames = ProductFilterStateProviderComponent.ProductSubcategoryNames.Value;
        var productNames = ProductFilterStateProviderComponent.ProductNames.Value;

        using var context = DbFactory.CreateDbContext();

        var query = context.SalesOrderDetails.AsQueryable();

        if (period is not null)
        {
            if (period.Start.HasValue)
            {
                query = query.Where(sod => sod.SalesOrder.OrderDate >= period.Start.Value);
            }

            if (period.End.HasValue)
            {
                query = query.Where(sod => sod.SalesOrder.OrderDate <= period.End.Value);
            }
        }

        if (countryRegionNames.Any())
        {
            query = query.Where(sod => countryRegionNames.Contains(sod.SalesOrder.BillToAddress.StateProvince.CountryRegionCodeNavigation.Name));
        }

        if (productCategoryNames.Any())
        {
            query = query.Where(sod => sod.Product.ProductSubcategory != null && productCategoryNames.Contains(sod.Product.ProductSubcategory.ProductCategory.Name));
        }

        if (productSubcategoryNames.Any())
        {
            query = query.Where(sod => sod.Product.ProductSubcategory != null && productSubcategoryNames.Contains(sod.Product.ProductSubcategory.Name));
        }

        if (productNames.Any())
        {
            query = query.Where(sod => productNames.Contains(sod.Product.Name));
        }

        var items = await query
            .GroupBy(sod => sod.Product.ProductSubcategory == null ? "Other" : sod.Product.ProductSubcategory.Name)
            .Select(g => new Top3SubcategoriesWithHighestGrossMarginItem
            {
                ProductSubcategoryName = g.Key,
                GrossMargin = (g.Sum(sod => sod.LineTotal) - g.Sum(sod => sod.UnitCost * sod.OrderQty)) / g.Sum(sod => sod.LineTotal)
            })
            .OrderByDescending(item => item.GrossMargin)
            .Take(3)
            .ToListAsync();

        List<ChartSeries> chartSeries = new();

        for (int i = 0; i < items.Count; i++)
        {
            ChartSeries chartSerie = new()
            {
                Name = $"{items[i].ProductSubcategoryName} ({items[i].GrossMargin.ToString("P2")})",
                Data = new double[items.Count]
            };

            chartSerie.Data[i] = (double)items[i].GrossMargin;

            chartSeries.Add(chartSerie);
        }

        ChartSeries = chartSeries;

        IsChartDataLoading = false;

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ProductFilterChangedSubscription?.Dispose();
    }
}
