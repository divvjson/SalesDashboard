@using Microsoft.EntityFrameworkCore
@using SalesDashboard.Entities

@implements IDisposable

@inject IDbContextFactory<AdventureWorksContext> DbFactory

<div class="sales-trend-top-3-countries">
    <MudChart ChartType="ChartType.Line" ChartSeries="ChartSeries" XAxisLabels="GetXAxisLabels()" Width="100%" Height="275px" />
</div>

@code {
    [CascadingParameter]
    public RegionalFilterStateProviderComponent RegionalFilterStateProviderComponent { get; set; } = null!;

    private IDisposable? RegionalFilterChangedSubscription { get; set; }

    private bool IsChartSeriesLoading { get; set; } = true;

    private List<ChartSeries> ChartSeries { get; set; } = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            RegionalFilterChangedSubscription = RegionalFilterStateProviderComponent.RegionalFilterChanged
                .Throttle(TimeSpan.FromMilliseconds(100))
                .Subscribe(async _ => await RequeryChartSeriesAsync());

            await RequeryChartSeriesAsync();
        }
    }

    private async Task RequeryChartSeriesAsync()
    {
        IsChartSeriesLoading = true;

        await InvokeAsync(StateHasChanged);

        var from = RegionalFilterStateProviderComponent.From.Value;
        var through = RegionalFilterStateProviderComponent.Through.Value;
        var countryRegionCodes = RegionalFilterStateProviderComponent.CountryRegionCodes.Value;
        var productCategoryNames = RegionalFilterStateProviderComponent.ProductCategoryNames.Value;
        var productSubcategoryNames = RegionalFilterStateProviderComponent.ProductSubcategoryNames.Value;
        var productNames = RegionalFilterStateProviderComponent.ProductNames.Value;

        var query = DbFactory.CreateDbContext().SalesOrderDetails.AsQueryable();

        query = query.Where(sod => sod.SalesOrder.OrderDate >= from);
        query = query.Where(sod => sod.SalesOrder.OrderDate <= through);

        if (countryRegionCodes.Any())
        {
            query = query.Where(sod => countryRegionCodes.Contains(sod.SalesOrder.BillToAddress.StateProvince.CountryRegionCode));
        }

        if (productCategoryNames.Any())
        {
            query = query.Where(sod => sod.Product.ProductSubcategory != null && productCategoryNames.Contains(sod.Product.ProductSubcategory.ProductCategory.Name));
        }

        if (productSubcategoryNames.Any())
        {
            query = query.Where(sod => sod.Product.ProductSubcategory != null && productSubcategoryNames.Contains(sod.Product.ProductSubcategory.Name));
        }

        if (productNames.Any())
        {
            query = query.Where(sod => productNames.Contains(sod.Product.Name));
        }

        var sales = await query
            .GroupBy(sod => new { sod.SalesOrder.OrderDate.Year, sod.SalesOrder.BillToAddress.StateProvince.CountryRegionCodeNavigation.Name })
            .Select(g => new Sale
                {
                    Year = g.Key.Year,
                    CountryName = g.Key.Name,
                    TotalSales = g.Sum(sod => sod.SalesOrder.SubTotal)
                })
            .ToListAsync();

        var years = sales
            .Select(sale => sale.Year)
            .Distinct()
            .OrderBy(year => year)
            .ToArray();

        var top3Countries = sales
            .GroupBy(sale => sale.CountryName)
            .Select(g => new
                {
                    CountryName = g.Key,
                    TotalSales = g.Sum(sale => sale.TotalSales)
                })
            .OrderByDescending(x => x.TotalSales)
            .Take(3)
            .Select(x => x.CountryName)
            .ToList();

        var filteredSales = sales
            .Where(sale => top3Countries.Contains(sale.CountryName))
            .ToList();

        var chartSeries = filteredSales
            .GroupBy(c => c.CountryName)
            .Select(g => new ChartSeries
                {
                    Name = g.Key,
                    Data = years.Select(year => Convert.ToDouble(g.FirstOrDefault(x => x.Year == year)?.TotalSales ?? 0)).ToArray()
                })
            .ToList();

        ChartSeries = chartSeries;

        IsChartSeriesLoading = false;

        await InvokeAsync(StateHasChanged);
    }

    private string[] GetXAxisLabels()
    {
        var from = RegionalFilterStateProviderComponent.From.Value;
        var through = RegionalFilterStateProviderComponent.Through.Value;

        int startYear = from.Year;
        int endYear = through.Year;
        int numberOfYears = endYear - startYear + 1;

        string[] years = new string[numberOfYears];

        for (int i = 0; i < numberOfYears; i++)
        {
            years[i] = (startYear + i).ToString();
        }

        return years;
    }

    public void Dispose()
    {
        RegionalFilterChangedSubscription?.Dispose();
    }
}
