@using Microsoft.EntityFrameworkCore
@using SalesDashboard.Components.Shared.SpinnerOverlay
@using SalesDashboard.Entities

@implements IDisposable
@inject IDbContextFactory<AdventureWorksContext> DbFactory

<SpinnerOverlayComponent IsVisible="IsChartDataLoading">
    <div class="sales-trend-top-3-countries">
        @if (ChartSeries.Any() is false)
        {
            
        }
        else if (Years.Count() is 1)
        {
            <div class="no-data-or-trend">NO TREND</div>
        }
        else
        {
            <MudChart ChartType="ChartType.Line"
                      ChartSeries="ChartSeries"
                      ChartOptions="ChartOptions"
                      XAxisLabels="Years"
                      Width="100%"
                      Height="100%" />
        }
    </div>
</SpinnerOverlayComponent>

@code {
    [CascadingParameter]
    public RegionalFilterStateProviderComponent RegionalFilterStateProviderComponent { get; set; } = null!;

    private IDisposable? RegionalFilterChangedSubscription { get; set; }

    private bool IsChartDataLoading { get; set; } = false;

    private string[] Years { get; set; } = [];

    private List<ChartSeries> ChartSeries { get; set; } = new();

    private ChartOptions ChartOptions { get; set; } = new()
    {
        YAxisTicks = 2,
        YAxisFormat = "0M"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            RegionalFilterChangedSubscription = RegionalFilterStateProviderComponent.RegionalFilterChanged
                .Throttle(TimeSpan.FromMilliseconds(25))
                .Subscribe(async _ => await RequeryChartDataAsync());

            await RequeryChartDataAsync();
        }
    }

    private async Task RequeryChartDataAsync()
    {
        IsChartDataLoading = true;

        await InvokeAsync(StateHasChanged);

        var period = RegionalFilterStateProviderComponent.Period.Value;
        var countryRegionNames = RegionalFilterStateProviderComponent.CountryRegionNames.Value;
        var productCategoryNames = RegionalFilterStateProviderComponent.ProductCategoryNames.Value;
        var productSubcategoryNames = RegionalFilterStateProviderComponent.ProductSubcategoryNames.Value;
        var productNames = RegionalFilterStateProviderComponent.ProductNames.Value;

        using var context = DbFactory.CreateDbContext();

        var query = context.SalesOrderDetails.AsQueryable();

        if (period is not null)
        {
            if (period.Start.HasValue)
            {
                query = query.Where(sod => sod.SalesOrder.OrderDate >= period.Start.Value);
            }

            if (period.End.HasValue)
            {
                query = query.Where(sod => sod.SalesOrder.OrderDate <= period.End.Value);
            }
        }

        if (countryRegionNames.Any())
        {
            query = query.Where(sod => countryRegionNames.Contains(sod.SalesOrder.BillToAddress.StateProvince.CountryRegionCodeNavigation.Name));
        }

        if (productCategoryNames.Any())
        {
            query = query.Where(sod => sod.Product.ProductSubcategory != null && productCategoryNames.Contains(sod.Product.ProductSubcategory.ProductCategory.Name));
        }

        if (productSubcategoryNames.Any())
        {
            query = query.Where(sod => sod.Product.ProductSubcategory != null && productSubcategoryNames.Contains(sod.Product.ProductSubcategory.Name));
        }

        if (productNames.Any())
        {
            query = query.Where(sod => productNames.Contains(sod.Product.Name));
        }

        var salesTrendTop3CountriesRecords = await query
            .GroupBy(sod => new
                { 
                    sod.SalesOrder.OrderDate.Year,
                    sod.SalesOrder.BillToAddress.StateProvince.CountryRegionCodeNavigation.Name
                })
            .Select(g => new SalesTrendTop3CountriesRecord
                {
                    Year = g.Key.Year,
                    CountryName = g.Key.Name,
                    TotalSales = g.Sum(sod => sod.LineTotal)
                })
            .ToListAsync();

        var years = salesTrendTop3CountriesRecords
            .Select(salesTrendRecord => salesTrendRecord.Year)
            .Distinct()
            .OrderBy(year => year)
            .ToArray();

        var top3Countries = salesTrendTop3CountriesRecords
            .GroupBy(salesTrendRecord => salesTrendRecord.CountryName)
            .Select(g => new
            {
                CountryName = g.Key,
                TotalSales = g.Sum(salesTrendRecord => salesTrendRecord.TotalSales)
            })
            .OrderByDescending(x => x.TotalSales)
            .Take(3)
            .Select(x => x.CountryName)
            .ToList();

        var filteredSales = salesTrendTop3CountriesRecords
            .Where(salesTrendRecord => top3Countries.Contains(salesTrendRecord.CountryName))
            .ToList();

        var chartSeries = filteredSales
            .GroupBy(salesTrendRecord => salesTrendRecord.CountryName)
            .Select(g => new ChartSeries
                {
                    Name = g.Key,
                    Data = years.Select(year => Convert.ToDouble(g.FirstOrDefault(x => x.Year == year)?.TotalSales / 1000000 ?? 0)).ToArray()
                })
            .ToList();

        Years = years
            .Select(year => year.ToString())
            .ToArray();

        ChartSeries = chartSeries;

        IsChartDataLoading = false;

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        RegionalFilterChangedSubscription?.Dispose();
    }
}
