@using Microsoft.Data.SqlClient
@using Microsoft.EntityFrameworkCore
@using SalesDashboard.Components.Shared.SpinnerOverlay
@using SalesDashboard.Entities
@using SalesDashboard.Helpers

@implements IDisposable
@inject IConfiguration Configuration

<SpinnerOverlayComponent IsLoading="IsLoading">

</SpinnerOverlayComponent>

@code {
    [CascadingParameter]
    public RegionalFilterStateProviderComponent RegionalFilterStateProviderComponent { get; set; } = null!;

    private IDisposable? RegionalFilterChangedSubscription { get; set; }

    private bool IsLoading { get; set; } = false;

    public List<RegionalSummaryMatrixGridItem> RegionalSummaryMatrixGridItems { get; set; } = [];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            RegionalFilterChangedSubscription = RegionalFilterStateProviderComponent.RegionalFilterChanged
                .Throttle(TimeSpan.FromMilliseconds(25))
                .Subscribe(async _ => await RequeryAsync());

            await RequeryAsync();
        }
    }

    private async Task RequeryAsync()
    {
        IsLoading = true;

        RegionalSummaryMatrixGridItems.Clear();

        await InvokeAsync(StateHasChanged);

        var dataSource = Configuration["DbDataSource"];
        var initialCatalog = Configuration["DbInitialCatalog"];
        var userId = Configuration["DbUserID"];
        var password = SecretsHelper.GetValue("DbPassword");

        var connectionString = $"Data Source={dataSource};Initial Catalog={initialCatalog};User ID={userId};Password={password};Encrypt=False;MultipleActiveResultSets=true";

        using SqlConnection connection = new(connectionString);

        try
        {
            await connection.OpenAsync();

            var cmdText = @"
                WITH LatestCost AS (
                    SELECT
                        pch.ProductID,
                        pch.StandardCost
                    FROM
                        Production.ProductCostHistory pch
                        INNER JOIN (
                            SELECT
                                ProductID,
                                MAX(ModifiedDate) AS LatestModifiedDate
                            FROM
                                Production.ProductCostHistory
                            GROUP BY
                                ProductID
                        ) latest ON pch.ProductID = latest.ProductID
                            AND pch.ModifiedDate = latest.LatestModifiedDate
                )
                SELECT
                    cr.Name AS CountryRegionName,
                    sp.Name AS StateProvinceName,
                    ba.City,
	                COUNT(*) AS QuantitySold,
                    SUM(sod.LineTotal) AS TotalSales,
                    SUM(lc.StandardCost) AS TotalCosts,
                    SUM(sod.LineTotal) - SUM(lc.StandardCost) AS GrossProfit,
                    CASE WHEN SUM(sod.LineTotal) = 0 THEN 0
                         ELSE (SUM(sod.LineTotal) - SUM(lc.StandardCost)) / SUM(sod.LineTotal) * 100
                    END AS GrossMargin
                FROM
                    Sales.SalesOrderDetail sod
                    JOIN Sales.SalesOrderHeader soh ON sod.SalesOrderID = soh.SalesOrderID
                    JOIN Person.Address ba ON soh.BillToAddressID = ba.AddressID
                    JOIN Person.StateProvince sp ON ba.StateProvinceID = sp.StateProvinceID
                    JOIN Person.CountryRegion cr ON sp.CountryRegionCode = cr.CountryRegionCode
                    JOIN Production.Product p ON sod.ProductID = p.ProductID
                    LEFT JOIN LatestCost lc ON p.ProductID = lc.ProductID
            ";

            using SqlCommand command = new(cmdText, connection);

            cmdText += @"
                GROUP BY
                    cr.Name, sp.Name, ba.City
                ORDER BY
                    cr.Name, sp.Name, ba.City;
            ";

            command.CommandText = cmdText;

            using SqlDataReader reader = await command.ExecuteReaderAsync();

            while (await reader.ReadAsync())
            {
                var item = new RegionalSummaryMatrixGridItem
                {
                    CountryRegionName = reader.GetString(reader.GetOrdinal("CountryRegionName")),
                    StateProvinceName = reader.GetString(reader.GetOrdinal("StateProvinceName")),
                    City = reader.GetString(reader.GetOrdinal("City")),
                    QuantitySold = reader.GetInt32(reader.GetOrdinal("QuantitySold")),
                    TotalSales = reader.GetDecimal(reader.GetOrdinal("TotalSales")),
                    TotalCosts = reader.GetDecimal(reader.GetOrdinal("TotalCosts")),
                    GrossProfit = reader.GetDecimal(reader.GetOrdinal("GrossProfit")),
                    GrossMargin = reader.GetDecimal(reader.GetOrdinal("GrossMargin"))
                };

                RegionalSummaryMatrixGridItems.Add(item);
            }
        }
        finally
        {
            await connection.CloseAsync();
        }

        IsLoading = false;

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        RegionalFilterChangedSubscription?.Dispose();
    }
}
