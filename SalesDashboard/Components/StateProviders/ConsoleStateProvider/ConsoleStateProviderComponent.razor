@using SalesDashboard.Services

@implements IDisposable
@inject AdventureWorksDbCommandService AdventureWorksDbCommandService
@inject CircuitAccessor CircuitAccessor

<CascadingValue Value="this">
    @ChildContent
</CascadingValue>

@code {
    public BehaviorSubject<EnumConsoleState> ConsoleStateSubject = new(EnumConsoleState.Closed);

    public BehaviorSubject<AdventureWorksDbCommandInfo?> LatestConsoleLogEntrySubject = new(null);

    public BehaviorSubject<int> NumberOfNewConsoleLogEntriesSubject = new(0);

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private IDisposable? LatestDbCommandInfoSubcription { get; set; }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            LatestDbCommandInfoSubcription = AdventureWorksDbCommandService.DbCommandInfoEntries
                .Subscribe(keyValuePair => HandleLatestDbCommandInfo(keyValuePair));

            NumberOfNewConsoleLogEntriesSubject.OnNext(GetDbCommandInfoEntriesForThisCircuit().Count);
        }
    }

    public IReadOnlyList<KeyValuePair<string, AdventureWorksDbCommandInfo>> GetDbCommandInfoEntriesForThisCircuit()
    {
        return AdventureWorksDbCommandService.GetDbCommandInfoEntries
            .Where(keyValuePair => keyValuePair.Key == CircuitAccessor.CircuitId)
            .ToList();
    }

    private void HandleLatestDbCommandInfo(KeyValuePair<string, AdventureWorksDbCommandInfo> keyValuePair)
    {
        if (keyValuePair.Key == CircuitAccessor.CircuitId == false)
        {
            return;
        }

        var latestCommandInfoForThisCircuit = keyValuePair.Value;

        LatestConsoleLogEntrySubject.OnNext(latestCommandInfoForThisCircuit);

        // Only emit the number of new console log entries if the console is closed.
        if (ConsoleStateSubject.Value is EnumConsoleState.Closed)
        {
            NumberOfNewConsoleLogEntriesSubject.OnNext(NumberOfNewConsoleLogEntriesSubject.Value + 1);
        }
    }

    public void Toggle()
    {
        if (ConsoleStateSubject.Value is EnumConsoleState.Open)
        {
            Close();
        }
        else if (ConsoleStateSubject.Value is EnumConsoleState.Closed)
        {
            Open();
        }
    }

    public void Open()
    {
        if (ConsoleStateSubject.Value is EnumConsoleState.Closed)
        {
            ConsoleStateSubject.OnNext(EnumConsoleState.Open);
            NumberOfNewConsoleLogEntriesSubject.OnNext(0);
        }
    }

    public void Close()
    {
        if (ConsoleStateSubject.Value is EnumConsoleState.Open)
        {
            ConsoleStateSubject.OnNext(EnumConsoleState.Closed);
        }
    }

    public void Clear()
    {
        AdventureWorksDbCommandService.RemoveDbCommandInfoByCircuitId(CircuitAccessor.CircuitId);
        NumberOfNewConsoleLogEntriesSubject.OnNext(0);
    }

    public void Dispose()
    {
        LatestDbCommandInfoSubcription?.Dispose();
    }
}
